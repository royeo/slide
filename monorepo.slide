Monorepo

Jianan Lu
ljn6176@163.com
https://github.com/royeo
http://lujianan.com/

* Introduction

ç®€å•æ¥è¯´ï¼Œmonorepo å°±æ˜¯ä¸€ä¸ªä»“åº“åŒ…å«å¤šä¸ªé¡¹ç›®ã€‚

Googleã€Facebookã€Twitter éƒ½é‡‡ç”¨äº†éå¸¸å¤šçš„ monorepoã€‚

Monorepo â‰  Monolithï¼ŒMonolith æ˜¯ä¸€ä¸ªåº”ç”¨ç¨‹åºåŒ…å«å¤§é‡è€¦åˆä»£ç ï¼Œå¾ˆéš¾ç»´æŠ¤ã€‚

* Multirepo vs Monorepo

* Multirepo

Pros:

    * æ¯ä¸ªä»“åº“æ‹¥æœ‰æ›´å¥½çš„è§„æ¨¡ï¼Œæ›´å°çš„ä»£ç åº“ï¼Œæ›´æ˜“äºç®¡ç†ã€‚
    * æ¯ä¸ªä»“åº“éƒ½æœ‰æ˜ç¡®çš„æ‰€æœ‰æƒï¼Œä¸€ä¸ªå°å›¢é˜Ÿå¯ä»¥æ‹¥æœ‰å®Œæ•´çš„å¾®æœåŠ¡å †æ ˆï¼Œå¹¶è¿›è¡Œç‹¬ç«‹å¼€å‘å’Œéƒ¨ç½²ã€‚

Cons:

    * è·¨ä»“åº“çš„æ”¹åŠ¨æ•ˆç‡ä½
    * ä»“åº“æƒé™çš„åˆ†é…ç¹ç
    * ä»£ç é£æ ¼æ— æ³•ç»Ÿä¸€
    * protoæ–‡ä»¶éš¾ä»¥ç®¡ç†
    * éšç€ä»“åº“è¶Šæ¥è¶Šå¤šï¼Œä¸å¯é¿å…çš„ä¼šäº§ç”Ÿä¸€äº›æ··ä¹±

* Monorepo

Pros:

    * æ˜“äºä»£ç é‡ç”¨
    * ç®€åŒ–çš„ä¾èµ–ç®¡ç†
    * æ˜“äºæ­å»ºå¼€å‘ç¯å¢ƒ
    * åŸå­æäº¤ï¼Œæ˜“äºåè°ƒæœåŠ¡é—´çš„æ›´æ”¹ï¼Œä»¥åŠè¿›è¡Œå¤§è§„æ¨¡çš„é‡æ„
    * ç»Ÿä¸€çš„ lint, build, test å’Œ release è¿‡ç¨‹
    * æœ‰æ•ˆçš„ code review

Consï¼š

    * ä»“åº“ä¼šå˜å¾—å¾ˆå¤§
    * ä¸¢å¤±æ¯ä¸ªé¡¹ç›®çš„ç‰ˆæœ¬ä¿¡æ¯
    * æ— æ³•æ§åˆ¶ä¸åŒé¡¹ç›®çš„è®¿é—®æƒé™
    * éœ€è¦æ›´å¤æ‚çš„æ„å»ºå·¥å…·
    
* Conclusion

Monorepo æœ‰æ›´å¤šçš„ä¼˜ç‚¹ï¼Œå¹¶ä¸”å®ƒçš„ç¼ºç‚¹ä¹Ÿèƒ½å¤Ÿè¢«å¤„ç†å¥½ã€‚

* Challenges

* Consider

- Repo structure
- Dependency management
- Development environment
- Code review
- CI/CD

* Repo structure

    â”œâ”€â”€ base
    â”œâ”€â”€ docs
    â”œâ”€â”€ proto
    â”œâ”€â”€ scripts
    â”œâ”€â”€ services
    â”‚   â”œâ”€â”€ svcA
    â”‚   â””â”€â”€ svcB
    â”œâ”€â”€ .gitlab-ci.yml
    â”œâ”€â”€ docker-compose.yml
    â”œâ”€â”€ go.mod
    â”œâ”€â”€ go.sum
    â”œâ”€â”€ Makefile
    â”œâ”€â”€ OWNERS
    â””â”€â”€ README.md

* Dependency management

ä½¿ç”¨ Go1.11 moduleã€‚

	go build ./...
	go mod tidy

åŸºç¡€ç»„ä»¶çš„é€šç”¨ä»£ç æ”¾åˆ° base ç›®å½•ä¸‹å…±äº«ã€‚

å¯¹å…±äº«ä»£ç åšå‡º breaking change éœ€è¦æ‰¿æ‹…ç›¸åº”çš„ä»£ä»·ã€‚

ä¸ºäº†é¿å…è€¦åˆï¼Œå¯ä»¥é€‚å½“è¿å DRYã€‚

* Development environment

- ä½¿ç”¨ docker-compose æ­å»ºå¼€å‘ç¯å¢ƒ
- ä½¿ç”¨ goimports æˆ– goreturns æ ¼å¼åŒ–ä»£ç ã€è‡ªåŠ¨å¯¼å…¥
- ä½¿ç”¨ golintï¼Œgo vet è¿›è¡Œä»£ç é™æ€æ£€æŸ¥
- ä½¿ç”¨ prototool ç”Ÿæˆ protobuf ä»£ç 
- ä½¿ç”¨ zs CLI å·¥å…·ç”ŸæˆæœåŠ¡æ¨¡æ¿ï¼ˆè¿˜åœ¨å®Œå–„ä¸­...ï¼‰

* Code review

ç›®å‰ GitLab CE ä¸æ”¯æŒè®¾ç½® approvers å’Œ reviewers.

Compromiseï¼š

- é€šè¿‡ watch ä»“åº“æ¥æ¥æ”¶æ‰€æœ‰ merge request é€šçŸ¥
- ä»»ä½•äººéƒ½å¯ä»¥ review ä»–äººä»£ç ï¼Œå¹¶æå‡ºæœ‰æ„ä¹‰çš„ comment
- è¯„è®º ğŸ‘ã€+1ã€LGTM è¡¨ç¤ºå·²ç» review è¿‡ä»£ç 
- æ ¸å¿ƒæˆå‘˜è®¾ç½®ä¸º Maintainerï¼Œæ¥è¿›è¡Œ merge æ“ä½œ
- ä½¿ç”¨ OWNERS æ–‡ä»¶æ¥æè¿°æ¯ä¸ªæœåŠ¡çš„ ownerï¼Œæ–‡ä»¶è§„èŒƒå‚è€ƒ GitLab Code Owners

* CI/CD

Lint

- golang
- protobuf

Test

- partial test

Deploy

- manual build, release

* Repo name

- zs
- mono
- optimus
- prime
- stormy
- wing
- skyscraper
- palace
